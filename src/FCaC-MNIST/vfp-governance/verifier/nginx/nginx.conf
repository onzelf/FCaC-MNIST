events { worker_connections 1024; }

http {

  server {
    listen 8443 ssl;
    server_name verifier.local;

    ssl_certificate           /etc/nginx/certs/verifier.crt;
    ssl_certificate_key       /etc/nginx/certs/verifier.key;

    ssl_client_certificate    /etc/nginx/certs/ca.crt;
    ssl_verify_depth          2;
    ssl_verify_client         optional;

    proxy_set_header Host              $host;
    proxy_set_header X-Forwarded-For   $remote_addr;

    proxy_set_header X-SSL-Client-Verify   $ssl_client_verify;
    proxy_set_header X-SSL-Client-S-DN     $ssl_client_s_dn;

    # ---------- Public: health/attestation ----------
    location = /health {
      proxy_pass http://verifier-app:9000/attest;
    }

    # ---------- Admin-only (phones): start short-lived session ----------
    location = /verify-start {
      if ($ssl_client_verify != SUCCESS)                                        { return 401; }
      if ($ssl_client_s_dn !~ "CN=org_HospitalA_admin|CN=org_HospitalB_admin")  { return 403; }
      proxy_pass http://verifier-app:9000/verify-start;
    }

    # ---------- Admin-only: read/update policy ----------
    location = /policy {
      if ($ssl_client_verify != SUCCESS)                                        { return 401; }
      if ($ssl_client_s_dn !~ "CN=org_HospitalA_admin|CN=org_HospitalB_admin")  { return 403; }
      proxy_pass http://verifier-app:9000/policy;
    }

    # ---------- Hub-only: claim code → session_id ----------
    location = /session/claim {
      if ($ssl_client_verify != SUCCESS)  { return 401; }
      if ($ssl_client_s_dn !~ "CN=hub")   { return 403; }
      proxy_pass http://verifier-app:9000/session/claim;
    }

    # ---------- Hub-only: admission control ----------
    location = /admission/check {
      if ($ssl_client_verify != SUCCESS)  { return 401; }
      if ($ssl_client_s_dn !~ "CN=hub")   { return 403; }
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_pass http://verifier-app:9000/admission/check;
    }

    # ---------- Hub-only: mint ECT (governance command) ----------
    location = /mint_ect {
      if ($ssl_client_verify != SUCCESS)  { return 401; }
      if ($ssl_client_s_dn !~ "CN=hub")   { return 403; }
      proxy_set_header X-Forwarded-Proto https;
      proxy_pass http://verifier-app:9000/mint_ect;
    }

    # ---------- Predictions (kept as-is) ----------
    location ~ ^/predict_image/(\d+)$ {
      proxy_pass http://flower-server:8081/predict_image/$1;
    }

    # ---------- Hub-only: bind sovereignty envelope (β) ----------
    location = /beta/bind/init {
      if ($ssl_client_verify != SUCCESS) { return 401; }
      if ($ssl_client_s_dn !~ "CN=hub")  { return 403; }
      proxy_pass http://verifier-app:9000/beta/bind/init;
    }

    location = /beta/bind/approve {
      if ($ssl_client_verify != SUCCESS) { return 401; }
      if ($ssl_client_s_dn !~ "CN=hub")  { return 403; }
      proxy_pass http://verifier-app:9000/beta/bind/approve;
    }

    location = /beta/bind/status {
      if ($ssl_client_verify != SUCCESS) { return 401; }
      if ($ssl_client_s_dn !~ "CN=hub")  { return 403; }
      proxy_pass http://verifier-app:9000/beta/bind/status;
    }

    location = /status { proxy_pass http://verifier-app:9000/status; }

    location = /openapi.json {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto https;
      proxy_pass http://verifier-app:9000/openapi.json;
    }

    # ---------- Hub-only: envelope ops (renew/close, etc.) ----------
    location ^~ /envelope/ {
      if ($ssl_client_verify != SUCCESS)  { return 401; }
      if ($ssl_client_s_dn !~ "CN=hub")   { return 403; }
      proxy_pass http://verifier-app:9000;
    }

    location / { return 404; }
  }
}
